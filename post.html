
<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8' />
	<title>Lägg upp bild</title>
</head>

<body>
	<div style="width:320px; height:170px; ">
		<img id="picture" style="max-width:100%;max-height:100%"/><br> 
	</div>
	<input type="file" id="fileInput" name="file" /><br>
	<textarea id="description" placeholder="Skriv in en beskrivning här." rows="4" cols="50"></textarea><br>
	<input type="text" id="tags" placeholder="Skriv in taggar här."/><br><br>
	<button onclick="uploadFile()">Upload</button>
</body>

<script>

var fileReader = new FileReader();

fileInput.addEventListener("change",function(e) {
	fileReader.onload = function (readerEvent) {
		picture.src = readerEvent.target.result;
	}
	fileReader.readAsDataURL(fileInput.files[0]);
});

function uploadFile() {
	var url = 'http://nile16.nu:5984/media/';
	var file = fileInput.files[0];
	var xhr1 =  new XMLHttpRequest();
	xhr1.open('POST', url, true);
	xhr1.setRequestHeader("Content-Type", "application/json");
	xhr1.onreadystatechange = function(response) {
		if (xhr1.readyState == 4) {
			var docId = JSON.parse(xhr1.response).id;
			var docRev = JSON.parse(xhr1.response).rev;
			var name = encodeURIComponent(file.name);
			var type = file.type;
			var xhr2 = new XMLHttpRequest();
			xhr2.open('PUT', url+docId+'/'+name+'?rev='+docRev, true);
			xhr2.setRequestHeader('Content-Type', type);
			xhr2.onreadystatechange = function(response) {
				if (xhr2.readyState == 4) {
					console.log(xhr2.response);
					alert("Uploaded!");
				}
			}
			fileReader.onload = function (readerEvent) {
				xhr2.send(readerEvent.target.result);
			};
			fileReader.readAsArrayBuffer(file);
		}
	}
	xhr1.send(JSON.stringify({description:description.value,tags:tags.value}));
}
	
</script>

</html>